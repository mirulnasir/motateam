window.Aurigma=function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);class n{getIntegrationInfo(e,t){return fetch("https://customerscanvashub.com/"+`api/v1/tenants/${e}/integrations/${t}`).then(e=>e.json()).then(e=>{if(e.success)return e.result;throw new Error(e.error)})}async pingService(e){let t=1;let r=!1;for(;!r&&t<5;){503===(await fetch(e)).status?(await new Promise(e=>setTimeout(e,1e4)),t++):r=!0}return!!r||(console.warn("Project buffer service is temporarily unavailable, please try again later"),!1)}getToken(e,t,r){const n="https://customerscanvashub.com/"+`api/v1/tenants/${e}/integrations/gettoken`,i={origin:window.location.origin,userGuid:t,ecommerceDomain:r};return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>{if(e.success)return e.result;throw new Error(e.error)})}getTokenAndUserId(e,t,r){const n="https://customerscanvashub.com/"+`api/v1/tenants/${e}/integrations/getusertoken`,i={origin:window.location.origin,userGuid:t,ecommerceDomain:r};return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>{if(e.success)return e.result;throw new Error(e.error)})}getCcToken(e,t,r){const n="https://customerscanvashub.com/"+`api/v1/tenants/${e}/integrations/getcctoken`,i={origin:window.location.origin,userGuid:t,ecommerceDomain:r};return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>{if(e.success)return e.result;throw new Error(e.error)})}updateCcToken(e,t){const r="https://customerscanvashub.com/"+`api/v1/tenants/${e}/integrations/updatecctoken`,n={origin:window.location.origin,userToken:t};return fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>e.json()).then(e=>{if(e.success)return e.result;throw new Error(e.error)})}getAdditionalProducts(e,t,r){const n="https://customerscanvashub.com/"+`api/v1/tenants/${e}/integrations/GetAdditionalProducts`,i={origin:window.location.origin,ecommerceDomain:t,additionalProducts:r};return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>{if(e.success)return e.result;throw new Error(e.error)})}}var i;!function(e){e[e.Custom=0]="Custom",e[e.Shopify=1]="Shopify"}(i||(i={}));async function o(e,t,r,n,o,a){let s=JSON.parse(o.config);s=s.config||s;const c=function(e,t){switch(e.ecommerceSystemType){case i.Custom:return Object.assign(Object.assign({},t),{customersCanvasBaseUrl:e.customerCanvasUrl,dynamicImageUrl:e.dynamicImageUrl,preflightToolUrl:e.preflightUrl});case i.Shopify:return Object.assign(Object.assign({},t),{editorUrl:e.customerCanvasUrl,diUrl:e.dynamicImageUrl,preflightUrl:e.preflightUrl})}}(o,r.pluginSettings),d=function(){try{let e=document.querySelector("html").lang;return e=e.substr(0,2)}catch(e){return console.warn("Can't parse locale"),"EN"}}();s.language=s.language||d,c.language=c.language||d;let u=[n];return a&&a.length>0&&(u=[n].concat(a)),e=await e.init(u,t,s,c,r.existingOrder,n.quantity,{id:String(r.userId),tokenId:r.userToken},r.backOffice)}function a(e,t,r=!1){return new Promise((n,i)=>{const o="resolve_callback_"+Math.round(1e5*Math.random());window[o]=(...t)=>{delete window[o],document.head.removeChild(a);const r=Array.from(t);let i=e.split(",");i=i.map(e=>e.trim());const s=r.reduce((e,t,r)=>(e[i[r]]=t,e),{});n(s)};const a=document.createElement("script");a.type="module",a.onerror=e=>{console.error(`Failer load script from ${t}`),console.error(e),i(e)},t+=(t.indexOf("?")>=0?"&":"?")+"t="+Date.now(),a.text=r?`import ${e} from '${t}'; ${o}(${e}.default || ${e} );`:`import { ${e} } from '${t}'; ${o}(${e});`,document.head.appendChild(a)})}async function s(e){const t=[{importData:"editor",url:e.uiFrameworkUrl+"/editor.js",isDefault:!0},{importData:"ecommerceDriver",url:e.uiFrameworkUrl+c(e.ecommerceSystemType)}],r=await(n=t,"string"==typeof n?a(n,i):Promise.all(n.map(e=>a(e.importData,e.url,e.isDefault))));var n,i;return{editor:r[0].editor,driver:r[1].ecommerceDriver}}function c(e){switch(e){case i.Shopify:return"/drivers/shopify-driver.js";default:return"/drivers/default-driver.js"}}r.d(t,"Storefront",(function(){return d}));const d=new class{constructor(){this.apiClient=new n}get driver(){return this._driver}get editor(){return this._editor}get order(){return this._driver.orders.current}get projectsBufferUrl(){return this._projectsBufferUrl}async load(e,t,r){const n=Array.isArray(t)?t[0]:t,i=await this.apiClient.getIntegrationInfo(e.tenantId,String(n.id));setTimeout(()=>this.apiClient.pingService(i.projectsBufferUrl+"/ping"),0);let[a,c,{token:d,userId:u}]=await Promise.all([s(i),this.getCcToken(e),this.getTokenAndUserId(e)]);setInterval(async()=>{await this.updateCcToken(e.tenantId,c)},18e5),e.userToken=c,this._projectsBufferUrl=i.projectsBufferUrl,this._driver=a.driver,this._editor=a.editor,""===d&&(d=await this.getToken(e)),e.backOffice={assetProcessorUrl:e.backOffice?e.backOffice.assetProcessorUrl:i.assetProcessorUrl,assetStorageUrl:e.backOffice?e.backOffice.assetStorageUrl:i.assetStorageUrl,designAtomsApiUrl:e.backOffice?e.backOffice.designAtomsApiUrl:i.designAtomsApiUrl,tenantId:e.tenantId,userId:u,token:d};const l=JSON.parse(i.config);let f=[];if(l.additionalProducts&&l.additionalProducts.length>0){try{f=await this.apiClient.getAdditionalProducts(e.tenantId,window.location.origin,l.additionalProducts)}catch(e){try{f=l.additionalProducts.map(e=>window.Aurigma.Storefront.allProducts.find(t=>t.id==e.id))}catch(e){}}if(0===f.length)try{f=l.additionalProducts.map(e=>window.Aurigma.Storefront.allProducts.find(t=>t.id==e.id))}catch(e){}}Array.isArray(t)&&(f=f.concat(t.slice(1))),this._driver=await o(a.driver,a.editor,e,n,i,f),this._driver.config.vars=this._driver.config.vars||{},this._driver.config.vars.token=d,this._driver.config.vars.backOfficeUserId=u,this._driver.config.vars.unitId=e.tenantId;const g=i.templateAttributes.map(e=>({name:e.name,title:e.name,value:e.value}));return g.forEach(e=>{try{const t=JSON.parse(e.value);"object"==typeof t&&(e.value=t)}catch(e){}}),this._driver.products.current.attributes.push(...g),await this.renderEditor(this._driver,r,e.themeSettings),this}async loadIntegrationInfo(e,t){const r=await this.apiClient.getIntegrationInfo(e.tenantId,String(t.id));return this._projectsBufferUrl=r.projectsBufferUrl,this}async getToken(e){let t="";try{t=await this.apiClient.getToken(e.tenantId,e.userId.toString(),window.location.origin)}catch(e){console.warn("Failed to get token.")}return t}async getTokenAndUserId(e){let t={token:"",userId:0};try{t=await this.apiClient.getTokenAndUserId(e.tenantId,e.userId.toString(),e.ecommerceSystemDomain)}catch(e){console.warn("Failed to get token and user id.")}return t}async getCcToken(e){let t="";try{t=await this.apiClient.getCcToken(e.tenantId,e.userId,e.ecommerceSystemDomain)}catch(e){console.warn("Failed to get token.")}return t}async updateCcToken(e,t){try{await this.apiClient.updateCcToken(e,t)}catch(e){console.warn("Failed to update CC token.")}}async renderEditor(e,t,r){return t.innerHTML="",e.products.current.renderEditor(t,r),new Promise((e,r)=>{t.addEventListener("load",()=>{e()})})}}}]);